/*
 * @Author: zzw
 * @email: huanling.zhang@tuya.com
 * @LastEditors: zzw
 * @file name: power_memory.c
 * @Description: 断电记忆功能实现,关闭电源下次开机后，恢复到关闭电源时的工作状态
 * @Copyright: HANGZHOU TUYA INFORMATION TECHNOLOGY CO.,LTD
 * @Company: http://www.tuya.com
 * @Date: 2021-04-22
 * @LastEditTime: 2021-05-25
 *
 */

#include "power_memory.h"
#include "work_pattern.h"
#include "massage_system.h"

#define FLASH_ADDR              0x040000
#define FLASH_BUFF_LEN          256

volatile unsigned char Flash_Read_Buff[FLASH_BUFF_LEN] = {0};
volatile unsigned char Flash_Write_Buff[FLASH_BUFF_LEN] = { 0x00,0x11,0x22,0x33,0x44,0x55,0x66,0x77,
															0x90,0x91,0x92,0x93,0x94,0x95,0x96,0x97,
															0xa0,0xa1,0xa2,0xa3,0xa4,0xa5,0xa6,0xa7,
															0xb0,0xb1,0xb2,0xb3,0xb4,0xb5,0xb6,0xb7,
															0xc0,0xc1,0xc2,0xc3,0xc4,0xc5,0xc6,0xc7,
															0xd0,0xd1,0xd2,0xd3,0xd4,0xd5,0xd6,0xd7,
															0xe0,0xe1,0xe2,0xe3,0xe4,0xe5,0xe6,0xe7,
															0xf0,0xf1,0xf2,0xf3,0xf4,0xf5,0xf6,0xf7,
															0x00,0x11,0x22,0x33,0x44,0x55,0x66,0x77,
															0x90,0x91,0x92,0x93,0x94,0x95,0x96,0x97,
															0xa0,0xa1,0xa2,0xa3,0xa4,0xa5,0xa6,0xa7,
															0xb0,0xb1,0xb2,0xb3,0xb4,0xb5,0xb6,0xb7,
															0xc0,0xc1,0xc2,0xc3,0xc4,0xc5,0xc6,0xc7,
															0xd0,0xd1,0xd2,0xd3,0xd4,0xd5,0xd6,0xd7,
															0xe0,0xe1,0xe2,0xe3,0xe4,0xe5,0xe6,0xe7,
															0xf0,0xf1,0xf2,0xf3,0xf4,0xf5,0xf6,0xf7,
															0x00,0x11,0x22,0x33,0x44,0x55,0x66,0x77,
															0x90,0x91,0x92,0x93,0x94,0x95,0x96,0x97,
															0xa0,0xa1,0xa2,0xa3,0xa4,0xa5,0xa6,0xa7,
															0xb0,0xb1,0xb2,0xb3,0xb4,0xb5,0xb6,0xb7,
															0xc0,0xc1,0xc2,0xc3,0xc4,0xc5,0xc6,0xc7,
															0xd0,0xd1,0xd2,0xd3,0xd4,0xd5,0xd6,0xd7,
															0xe0,0xe1,0xe2,0xe3,0xe4,0xe5,0xe6,0xe7,
															0xf0,0xf1,0xf2,0xf3,0xf4,0xf5,0xf6,0xf7,
															0x00,0x11,0x22,0x33,0x44,0x55,0x66,0x77,
															0x90,0x91,0x92,0x93,0x94,0x95,0x96,0x97,
															0xa0,0xa1,0xa2,0xa3,0xa4,0xa5,0xa6,0xa7,
															0xb0,0xb1,0xb2,0xb3,0xb4,0xb5,0xb6,0xb7,
															0xc0,0xc1,0xc2,0xc3,0xc4,0xc5,0xc6,0xc7,
															0xd0,0xd1,0xd2,0xd3,0xd4,0xd5,0xd6,0xd7,
															0xe0,0xe1,0xe2,0xe3,0xe4,0xe5,0xe6,0xe7,
															0xf0,0xf1,0xf2,0xf3,0xf4,0xf5,0xf6,0xf7};

/***********************************************************
*   Function:  write_massage_status_to_flash
*   Input:     none
*   Output:    none
*   Return:    none
*   Notice:    Write the status of the massager to flash
***********************************************************/
void write_massage_status_to_flash(void)
{
	//Flash_Write_Buff[0] = massage_state.on_off;
	Flash_Write_Buff[0] = massage_state.pattern;
	Flash_Write_Buff[1] = massage_state.gear;
	Flash_Write_Buff[2] = massage_state.heat;

	flash_write_page(FLASH_ADDR, FLASH_BUFF_LEN, (unsigned char *)Flash_Write_Buff);

	return;
}

/**********************************************************************
*   Function:  read_massage_status_to_flash
*   Input:     none
*   Output:    none
*   Return:    none
*   Notice:    Read the status of the massager before power off from
*   		   flash and store it in the massager status structure
**********************************************************************/
void read_massage_status_to_flash(void)
{
	flash_read_page(FLASH_ADDR, FLASH_BUFF_LEN, (unsigned char *)Flash_Read_Buff);

    //Store the data read from flash into a structure
    //massage_state.on_off = Flash_Read_Buff[0];
    massage_state.pattern = Flash_Read_Buff[0];
    massage_state.gear = Flash_Read_Buff[1];
    massage_state.heat = Flash_Read_Buff[2];

    return;
}

/***********************************************************
*   Function:  erase_massage_flash
*   Input:     none
*   Output:    none
*   Return:    none
*   Notice:    Restore factory settings
***********************************************************/
void erase_massage_flash(void)
{
   //massage_state.on_off = OFF;
   massage_state.pattern = relieve;
   massage_state.gear = first_gear;
   massage_state.heat = off_heat;

   //Flash_Write_Buff[0] = OFF;
   Flash_Write_Buff[0] = relieve;
   Flash_Write_Buff[1] = first_gear;
   Flash_Write_Buff[2] = off_heat;

   flash_write_page(FLASH_ADDR, FLASH_BUFF_LEN, (unsigned char *)Flash_Write_Buff);

   return;
}

